<script>
// ------------------ tiny helpers ------------------
function setStatus(msg) {
  const el = document.getElementById("status-bar");
  if (el) el.textContent = msg;
}

// we will keep user in localStorage (like you had)
let currentUser = null;
const saved = localStorage.getItem("mo_user");
if (saved) {
  try {
    currentUser = JSON.parse(saved);
  } catch (e) {
    currentUser = null;
  }
}

// ------------------ renderer ------------------
function render(view) {
  const contentEl = document.getElementById("main-view");
  if (!contentEl) return;
  const navButtons = document.querySelectorAll("nav button, .side-nav button, .side-nav a");
  navButtons.forEach((b) => {
    if (b.dataset && b.dataset.view) {
      b.classList.toggle("active", b.dataset.view === view);
    }
  });

  // DASHBOARD
  if (view === "dashboard") {
    contentEl.innerHTML = `
      <div class="panel">
        <h2>Welcome ${currentUser ? currentUser.email : "Guest"}</h2>
        <p style="font-size:0.8rem;color:var(--muted);">
          This is your MarketOrbit MVP. Generate content, test posting, and review errors.
        </p>
      </div>
      <div class="two-col">
        <div class="panel">
          <h2>Quick Actions</h2>
          <button class="primary" onclick="render('content')">Generate content</button>
          <button class="secondary" onclick="render('scheduler')">View scheduler</button>
          <button class="secondary" onclick="render('activity')">See activity</button>
        </div>
        <div class="panel">
          <h2>Recent Activity</h2>
          <div id="recent-activity" style="font-size:0.7rem;color:var(--muted);">No activity yet.</div>
        </div>
      </div>
    `;
    // show top 5 if we already have them in memory (optional)
    renderActivityList("recent-activity", 5);
    return;
  }

  // CONTENT
  if (view === "content") {
    contentEl.innerHTML = `
      <div class="panel">
        <h2>Content / AI Studio</h2>
        <p>Enter a topic, generate a post (AI if key present), then optionally send to Facebook.</p>
        <label>TOPIC / IDEA</label>
        <input id="topic-input" placeholder="e.g. Reels tips for wellness brands" />
        <div style="margin-top:1rem;display:flex;gap:.5rem;">
          <button class="primary" onclick="generateDraft()">Generate draft</button>
          <button onclick="generateAndPost()">Generate &amp; post to Facebook</button>
        </div>
        <div id="content-result" style="margin-top:1rem;font-size:.75rem;"></div>
      </div>
    `;
    return;
  }

  // SCHEDULER (placeholder)
  if (view === "scheduler") {
    contentEl.innerHTML = `
      <div class="panel">
        <h2>Scheduler</h2>
        <p>Demo scheduler panel. (Later we'll add rows from Supabase.)</p>
      </div>
    `;
    return;
  }

  // ACTIVITY VIEW – this is where we use the Netlify function
  if (view === "activity") {
    contentEl.innerHTML = `
      <div class="panel">
        <h2>Activity / Errors</h2>
        <p class="muted" style="font-size:.7rem;">
          These entries come from your Supabase table <code>activity_logs</code> via the Netlify function
          <code>/.netlify/functions/get-logs</code>.
        </p>
        <p id="logs-status" style="font-size:.65rem;margin-top:.5rem;">Loading...</p>
        <div id="logs-container" style="margin-top:1rem;display:flex;flex-direction:column;gap:.5rem;"></div>
      </div>
    `;
    // fetch them
    loadActivityLogs();
    return;
  }
}

// ------------------ activity list helper (used on dashboard) ------------------
let activityLog = []; // we can push into this when we do actions

function addActivity(entry) {
  const row = {
    title: entry.title || "Activity",
    detail: entry.detail || null,
    time: new Date().toISOString(),
  };
  activityLog.unshift(row);
}

function renderActivityList(elId, limit) {
  const el = document.getElementById(elId);
  if (!el) return;
  const items = limit ? activityLog.slice(0, limit) : activityLog;
  if (!items.length) {
    el.innerHTML = `<p style="font-size:0.7rem;color:var(--muted);">No activity yet.</p>`;
    return;
  }
  el.innerHTML = items
    .map(
      (a) => `
      <div style="border-bottom:1px solid rgba(36,48,71,0.3);padding:.35rem 0;">
        <div style="font-size:0.65rem;color:rgba(203,213,245,0.5);">${a.time}</div>
        <div style="font-size:0.75rem;">${a.title}</div>
        ${a.detail ? `<pre>${JSON.stringify(a.detail, null, 2)}</pre>` : ""}
      </div>
    `
    )
    .join("");
}

// ------------------ actions (same shape as before) ------------------
async function generateDraft() {
  const topic = document.getElementById("topic-input").value || "Sample post from MarketOrbit MVP";
  setStatus("Generating draft...");
  const out = document.getElementById("content-result");
  out.innerHTML = "";

  const res = await fetch("/.netlify/functions/generate-and-post", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ topic, mode: "draft" }),
  });

  const data = await res.json();
  if (data.ok) {
    out.innerHTML = `<div class="success-banner">Draft generated.</div><pre>${data.caption}</pre>`;
    addActivity({ title: "Draft generated", detail: data });
  } else {
    out.innerHTML = `<div class="error-banner">${data.message || "Draft failed"}</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
    addActivity({ title: "Draft failed", detail: data });
  }
  setStatus("Ready.");
}

async function generateAndPost() {
  const topic = document.getElementById("topic-input").value || "Sample post from MarketOrbit MVP";
  setStatus("Generating and posting to Facebook...");
  const out = document.getElementById("content-result");
  out.innerHTML = "";

  const res = await fetch("/.netlify/functions/generate-and-post", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ topic, mode: "post" }),
  });

  const data = await res.json();
  if (data.ok) {
    out.innerHTML = `<div class="success-banner">Posted to Facebook ✅</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
    addActivity({ title: "Posted to Facebook", detail: data });
  } else {
    out.innerHTML = `<div class="error-banner">${data.message || "Post failed"}</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
    addActivity({ title: "Post to Facebook failed", detail: data });
  }
  setStatus("Ready.");
}

// ------------------ account save (from your old code) ------------------
function saveAccount() {
  const emailEl = document.getElementById("acct-email");
  const email = emailEl.value.trim();
  if (!email) return;
  currentUser = { email };
  localStorage.setItem("mo_user", JSON.stringify(currentUser));
  setStatus("Account saved locally.");
}

// fake login / fake register (from your old code)
document.addEventListener("DOMContentLoaded", () => {
  const fakeLogin = document.getElementById("fake-login-btn");
  if (fakeLogin) {
    fakeLogin.onclick = () => {
      currentUser = { email: "demo@marketorbit.app" };
      localStorage.setItem("mo_user", JSON.stringify(currentUser));
      setStatus("Logged in (local only).");
      render("dashboard");
    };
  }

  const fakeRegister = document.getElementById("fake-register-btn");
  if (fakeRegister) {
    fakeRegister.onclick = () => {
      currentUser = { email: "newuser@marketorbit.app" };
      localStorage.setItem("mo_user", JSON.stringify(currentUser));
      setStatus("Account created (local only).");
      render("dashboard");
    };
  }

  // hook up nav buttons with data-view
  document.querySelectorAll("[data-view]").forEach((b) => {
    b.addEventListener("click", () => render(b.dataset.view));
  });
});

// ------------------ NEW: load activity from Supabase via Netlify ------------------
async function loadActivityLogs() {
  const statusEl = document.getElementById("logs-status");
  const container = document.getElementById("logs-container");
  if (!statusEl || !container) return;

  statusEl.textContent = "Loading...";
  container.innerHTML = "";

  try {
    const res = await fetch("/.netlify/functions/get-logs");
    const data = await res.json();

    if (!data.ok) {
      statusEl.textContent = "Could not load logs.";
      container.innerHTML = `<pre class="text-xs text-red-300 bg-red-900/20 p-3 rounded">${JSON.stringify(data, null, 2)}</pre>`;
      return;
    }

    const logs = data.data;
    statusEl.textContent = `Loaded ${logs.length} log(s).`;

    if (!logs.length) {
      container.innerHTML = `<p class="text-sm text-slate-400">No logs yet.</p>`;
      return;
    }

    logs.forEach((row) => {
      const div = document.createElement("div");
      div.className = "rounded border border-slate-700 bg-slate-900/40 p-3 mb-2";
      div.innerHTML = `
        <div class="text-sm text-slate-100">${row.action || "unknown"} (${row.created_at || ""})</div>
        <div class="text-xs text-slate-400">${row.topic || ""}</div>
        <div class="text-xs text-slate-300">${row.caption || ""}</div>
        <div class="text-xs text-slate-400">${row.status || ""}</div>
        ${row.provider ? `<span class="ml-2 text-[10px] text-slate-400">${row.provider}</span>` : ""}
        ${row.raw ? `<pre class="mt-2 text-[10px] text-slate-200 bg-black/30 p-2 rounded overflow-auto">${JSON.stringify(row.raw, null, 2)}</pre>` : ""}
      `;
      container.appendChild(div);
    });
  } catch (err) {
    statusEl.textContent = "Error loading logs.";
    container.innerHTML = `<pre class="text-xs text-red-300 bg-red-900/20 p-3 rounded">${err}</pre>`;
  }
}

// ------------------ initial view ------------------
render("dashboard");
</script>
